# Telegram Import Tool

Утилита для импорта сообщений из экспорта Telegram в MongoDB для использования с RAG системой бота.

## Использование

### Подготовка

1. Сделайте экспорт чата из Telegram Desktop:
   - Settings → Advanced → Export Telegram data
   - Выберите чат и формат JSON
   - Убедитесь, что включены сообщения (Messages)

2. Убедитесь, что MongoDB запущен и доступен

3. Настройте переменные окружения (`.env` файл):
   ```bash
   MONGO_URL=mongodb://localhost:27017
   MONGO_DATABASE=sueta
   ```

### Запуск импорта

```bash
# Пробный запуск (только статистика, без сохранения в БД)
go run cmd/importer/main.go -file path/to/export.json -dry-run -v

# Тестирование парсинга без подключения к БД
go run cmd/importer/main.go -file path/to/export.json -dry-run -v --no-db

# Реальный импорт
go run cmd/importer/main.go -file path/to/export.json -v

# Без подробного вывода
go run cmd/importer/main.go -file path/to/export.json
```

### Флаги

- `-file` - путь к JSON файлу с экспортом Telegram (обязательный)
- `-dry-run` - режим пробного запуска, только показать статистику
- `-v` - подробный вывод (verbose)
- `-no-db` - не подключаться к БД (только для тестирования парсинга)

## Что импортируется

- **Информация о чате**: название, тип, ID
- **Сообщения пользователей**: текст, автор, дата, ID сообщения
- **Служебные сообщения**: создание группы, изменения и т.д.

## Что пропускается

- Сообщения без текста (медиафайлы, стикеры и т.д.)
- Сообщения с ошибками парсинга

## Формат экспорта

Поддерживается стандартный формат экспорта Telegram:

```json
{
  "name": "Название чата",
  "type": "private_supergroup",
  "id": 1698320716,
  "messages": [
    {
      "id": -999631748,
      "type": "message",
      "date": "2021-05-09T12:07:03",
      "from": "Имя пользователя",
      "from_id": "user262343524",
      "text": "Текст сообщения",
      "text_entities": []
    }
  ]
}
```

## Примеры использования

### Импорт с подробной статистикой

```bash
go run cmd/importer/main.go -file telegram_export.json -v
```

Выведет:
```
2025/07/15 10:30:00 Начинаем импорт из файла: telegram_export.json
2025/07/15 10:30:01 Найдено сообщений в экспорте: 15420
2025/07/15 10:30:01 Название чата: Чушпан Флойд и 4 ублюдка
2025/07/15 10:30:01 Тип чата: private_supergroup
2025/07/15 10:30:01 ID чата: 1698320716
2025/07/15 10:30:01 Обработано сообщений: 0/15420
2025/07/15 10:30:02 Обработано сообщений: 1000/15420
...
=== Статистика импорта ===
Всего обработано: 14850
Пользовательских сообщений: 14200
Служебных сообщений: 650
Пропущено: 570
Ошибок: 0
*** ИМПОРТ ЗАВЕРШЕН ***
```

### Проверка перед импортом

```bash
go run cmd/importer/main.go -file telegram_export.json -dry-run -v
```

Покажет статистику без сохранения в базу данных.

## Устранение проблем

### Ошибка подключения к MongoDB
```
Ошибка подключения к MongoDB: connection failed
```
- Убедитесь, что MongoDB запущен
- Проверьте переменную `MONGO_URL` в `.env`

### Ошибка парсинга JSON
```
Ошибка парсинга JSON: invalid character...
```
- Проверьте, что файл экспорта корректный JSON
- Убедитесь, что файл полностью загружен

### Дублирование данных
Утилита попытается сохранить чат и сообщения. Если чат уже существует, будет выведено предупреждение, но импорт продолжится.

Для сообщений дублирование определяется по `message_id` и `chat_id`. MongoDB выдаст ошибку при попытке вставить дубликат, но это не остановит весь процесс.

## Производительность

- Скорость: ~1000-5000 сообщений в секунду (зависит от MongoDB)
- Память: ~100MB для файла экспорта в 100MB
- Время: файл в 50MB (~50,000 сообщений) обрабатывается за 10-30 секунд

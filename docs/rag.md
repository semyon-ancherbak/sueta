# RAG (Retrieval-Augmented Generation) для Telegram бота Sueta

## Описание

Данная система расширяет возможности бота, позволяя ему не только использовать недавние сообщения (за последние 3 дня), но и находить релевантные старые сообщения из истории переписки.

## Компоненты

### 1. MongoDB Полнотекстовый поиск
- Создается текстовый индекс для полей `text`, `first_name`, `last_name`, `username` с поддержкой русского языка
- Поиск исключает сообщения за последние 3 дня (так как они уже включены в контекст)
- Результаты сортируются по релевантности (MongoDB text score)

### 2. RAG Service (`internal/rag/service.go`)
- Извлекает ключевые слова из сообщения пользователя
- Удаляет стоп-слова и упоминания бота
- Выполняет поиск релевантных сообщений через MongoDB
- Возвращает как недавние, так и релевантные сообщения

### 3. Расширенный LLM Client
- Новый метод `GenerateResponseWithRAG` включает релевантные сообщения в системный промпт
- Релевантные сообщения передаются как дополнительный контекст
- LLM может использовать эту информацию для более точных ответов

## Алгоритм работы

1. **Обработка сообщения**: При получении сообщения, адресованного боту
2. **Извлечение ключевых слов**: Из сообщения пользователя извлекаются значимые слова
3. **Поиск релевантного контекста**: 
   - Получение недавних сообщений (последние 3 дня)
   - Поиск старых релевантных сообщений по ключевым словам
4. **Генерация ответа**: 
   - Если найдены релевантные сообщения → используется RAG
   - Иначе → используется обычный контекст

## Настройки

- **Максимальное количество релевантных сообщений**: 5 (настраивается в `handleBotMessage`)
- **Исключение недавних сообщений**: 3 дня (настраивается в `SearchRelevantMessages`)
- **Минимальная длина ключевых слов**: 3 символа

## Примеры использования

### Сценарий 1: Вопрос о прошлых обсуждениях
```
Пользователь: "Жорик, помнишь, мы говорили о Docker контейнерах?"
```
1. Ключевые слова: `docker контейнерах`
2. Поиск находит старые сообщения с упоминанием Docker
3. LLM получает как недавний контекст, так и релевантные старые сообщения
4. Ответ основан на полной истории обсуждения Docker

### Сценарий 2: Общий вопрос
```
Пользователь: "Как дела?"
```
1. Ключевые слова: `дела`
2. Поиск может не найти специфических релевантных сообщений
3. Используется обычный контекст из недавних сообщений

## Возможные улучшения

1. **Семантический поиск**: Использование векторных embeddings для более точного поиска
2. **Персонализация**: Учет предпочтений пользователя при ранжировании
3. **Кэширование**: Сохранение результатов поиска для повторных запросов
4. **Фильтрация по времени**: Настраиваемые временные рамки для поиска
5. **Анализ тональности**: Учет эмоционального контекста сообщений
